# Карта депо + распознавание поездов

Проект: интерактивная карта (Яндекс.Карты) и бэкенд распознавания поездов по камерам/скриншотам. Карта показывает фигуры депо и поезда (вручную или по WebSocket от `camall_screen_capture.py`).

## Структура

- **Корень** — карта для GitHub Pages: `index.html`, `train.png`.
- **demo-point-layer/** — исходники карты (дублируют корень).
- **gpu+out/** — Python: распознавание, камеры, WebSocket на порт 8765.
- **memory-bank/** — техописание стека.

## Как открыть карту по ссылке (GitHub Pages)

1. Создайте репозиторий на GitHub, залейте этот проект.
2. **Settings → Pages** → Source: **Deploy from a branch** → Branch: `main`, Folder: **/ (root)** → Save.
3. Через пару минут карта будет доступна по адресу:  
   `https://<ваш-логин>.github.io/<имя-репо>/`
4. **Яндекс API:** в [Кабинете разработчика](https://developer.tech.yandex.ru/) в настройках ключа добавьте в «Разрешить запросы с» домен:  
   `https://<ваш-логин>.github.io`  
   (или `*.github.io`), иначе карта на GitHub Pages может не загружаться.

На GitHub Pages **WebSocket к localhost:8765 не работает** — это нормально. Он нужен только при локальном запуске распознавания. Карта при этом работает: ручное добавление прямоугольников, координаты, масштаб.

### Скриншоты с твоего сервера на карте (GitHub Pages)

Сервер скриншотов (`serve_last_screenshot.py`) на GitHub запустить нельзя — он должен работать у тебя на машине или на любом хостинге с белым IP. Если у тебя уже есть доступный по интернету адрес этого сервера (например `https://твой-сервер.com` или туннель вроде ngrok), открой карту с параметром:

- **Скриншот:**  
  `https://<логин>.github.io/<репо>/?screenshot_url=https://твой-сервер.com`  
  Карта будет подгружать последний скриншот с `https://твой-сервер.com/last.jpg`.

- **WebSocket (опционально):**  
  `?ws_url=wss://твой-сервер.com`  
  — если поднимешь WebSocket для распознавания на том же сервере.

**CORS при использовании ngrok:** браузер отправляет preflight (OPTIONS) к ngrok; без CORS-заголовков в ответе карта не загрузит скриншот. Запускай ngrok **с политикой**, которая отвечает на OPTIONS с CORS и добавляет заголовок к ответам GET:

1. Запусти сервер: `python gpu+out/serve_last_screenshot.py`
2. Запусти ngrok с файлом политики (из корня репо):  
   `ngrok http 8766 --traffic-policy-file=gpu+out/ngrok-cors-policy.yml`  
   Файл `gpu+out/ngrok-cors-policy.yml` лежит в репо.

Без `--traffic-policy-file` preflight может не получать CORS, и загрузка с GitHub Pages будет падать с ошибкой CORS.

**Один скрипт для запуска (Windows):** из корня репо выполни в PowerShell:  
`.\start_screenshot_and_ngrok.ps1`  
Скрипт остановит старые процессы на 8766 и ngrok, запустит сервер и ngrok с политикой в отдельных окнах и откроет в браузере карту с актуальной ссылкой на скриншот. Если скрипт ругается на выполнение:  
`Set-ExecutionPolicy -Scope CurrentUser -ExecutionPolicy RemoteSigned`  
затем снова `.\start_screenshot_and_ngrok.ps1`.

## Поезда видны всем по ссылке (Firebase)

Чтобы добавленные прямоугольники (поезда) сохранялись и отображались у **всех**, кто открыл карту по ссылке:

1. Создайте проект на [Firebase Console](https://console.firebase.google.com/).
2. Включите **Realtime Database** (в разделе Build). Выберите регион (например europe-west1). В **Rules** задайте для теста: `".read": true, ".write": true` (для продакшена позже можно ограничить по домену).
3. В настройках проекта: **Настройки проекта → Ваши приложения** → добавьте веб-приложение, скопируйте конфиг (apiKey, authDomain, **databaseURL**, projectId, storageBucket, messagingSenderId, appId).
4. В репозитории откройте **firebase-config.js** и подставьте конфиг в `FIREBASE_CONFIG` (сейчас там `null`). Закоммитьте и запушьте (конфиг Firebase не секрет для клиента, но при желании можно не коммитить свой `firebase-config.js` и настроить его только локально).
5. После деплоя на GitHub Pages: кто добавляет или удаляет поезда — изменения сразу видны у всех, кто открыл ту же ссылку.

## Локальный запуск (карта + распознавание)

1. **Карта:** откройте `index.html` в браузере или запустите из папки корня/`demo-point-layer`:  
   `npx serve .`
2. **Распознавание (опционально):** в `gpu+out/` создайте `config_screen_capture.json` (скопируйте из `config_screen_capture.example.json` и заполните, включая БД). Запустите:  
   `python camall_screen_capture.py`  
   Карта будет получать события поездов по WebSocket на порт 8765.

Конфиги `config_screen_capture.json` и `config_cams.json` содержат пароли и **не попадают в репозиторий** (см. `.gitignore`). Используйте примеры `*.example.json` для настройки у себя.
